---
- name: Create Database virtual machine
  hosts: localhost
  gather_facts: yes
  vars_files:
    - secrets.yml
  vars:
    ansible_python_interpreter: "/home/joju0195/.ansible-venv/bin/python3"
    vm_password: "db"
    template_id: 3036

  tasks:
    - name: Ensure SSH key exists
      community.crypto.openssh_keypair:
        path: "/home/joju0195/.ssh/id_ed25519"
        type: ed25519
        state: present

    - name: Create VM from template
      one_vm:
        api_url: "https://grid5.mif.vu.lt/cloud3/RPC2"
        api_username: "{{ db_username }}"
        api_password: "{{ db_password }}"
        template_id: "{{ template_id }}"
        state: present
        wait: yes
        attributes:
          name: "Database-VM"
      register: vm_result

    - name: Extract VM IP
      set_fact:
        vm_private_ip: "{{ vm_result.instances[0].networks[0].ip }}"

    - name: Wait for SSH
      wait_for:
        host: "{{ vm_private_ip }}"
        port: 22
        timeout: 300
        delay: 15

    - name: Install SSH key
      command: >
        sshpass -p "{{ vm_password }}"
        ssh-copy-id -i "/home/joju0195/.ssh/id_ed25519.pub"
        -o StrictHostKeyChecking=no
        {{ db_username }}@{{ vm_private_ip }}

    - name: Register host for DB group
      add_host:
        name: "{{ vm_private_ip }}"
        groups: DB
        ansible_user: "{{ db_username }}"
        ansible_ssh_private_key_file: "/home/joju0195/.ssh/id_ed25519"
        ansible_ssh_common_args: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
        ansible_become: yes
        ansible_become_password: "{{ db_sudo_password }}"
        ansible_become_method: sudo

- name: Configure DB VM with Docker + MySQL
  hosts: DB
  vars_files:
    - secrets.yml
  become: yes
  gather_facts: yes
  vars:
    db_root_password: dbpassword
    db_name: machinerepairshop

  tasks:
    - name: Ensure apt lists folder exists (fix missing lock error)
      file:
        path: /var/lib/apt/lists
        state: directory
        mode: '0755'

    - name: Update apt
      apt:
        update_cache: yes

    - name: Install required dependencies
      apt:
        name:
          - ca-certificates
          - curl
          - gnupg
        state: present
        update_cache: yes

    - name: Add Docker GPG key (Ubuntu 24.04 format)
      shell: |
        install -m 0755 -d /etc/apt/keyrings
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg \
        | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
        chmod a+r /etc/apt/keyrings/docker.gpg

    - name: Add Docker repo for Ubuntu 24.04 Noble
      copy:
        dest: /etc/apt/sources.list.d/docker.list
        content: |
          deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu noble stable

    - name: Update apt again
      apt:
        update_cache: yes

    - name: Install Docker
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
        state: present

    - name: Ensure python3-requests and python3-docker apt packages installed
      become: yes
      apt:
        name:
          - python3-requests
          - python3-docker
        state: present
        update_cache: yes
    - name: Copy SQL data
      copy:
        src: /home/joju0195/MachineRepairShop/Misc/data.sql
        dest: /home/{{ ansible_user }}/data.sql
        mode: '0644'    


    - name: Run MariaDB Docker Container
      community.docker.docker_container:
        name: mysql_db
        image: mariadb:10.11
        state: started
        restart_policy: always
        env:
          MARIADB_ROOT_PASSWORD: "{{ db_root_password }}"
          MARIADB_DATABASE: "{{ db_name }}"
        published_ports:
          - "3306:3306"
        volumes:
          - /home/{{ ansible_user }}/data.sql:/docker-entrypoint-initdb.d/data.sql

