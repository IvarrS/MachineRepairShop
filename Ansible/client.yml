---
- name: Provision VM on OpenNebula
  hosts: localhost
  gather_facts: yes
  vars_files:
    - secrets.yml
  vars:
    # User configuration
    desktop_user: "client"
    desktop_password: "client"
    browser_port: 90
    
  tasks:
    - name: Create VM with port forwarding
      one_vm:
        api_url: "https://grid5.mif.vu.lt/cloud3/RPC2"
        api_username: "{{ client_user }}"
        api_password: "{{ client_pass }}"
        template_id: 3001
        count: 1
        cpu: 1
        memory: 4 GB
        disk_size: 10 GB
        state: present
        wait: yes
        attributes:
          name: desktop-vm
          TCP_PORT_FORWARDING: "22,3389,{{ browser_port }}"
      register: vm_result
      
    - name: Display VM creation result
      debug:
        var: vm_result
        
    - name: Extract VM information
      set_fact:
        vm_id: "{{ vm_result.instances[0].vm_id }}"
        vm_private_ip: "{{ vm_result.instances[0].networks[0].ip }}"
        vm_owner_name: "{{ vm_result.instances[0].owner_name }}"
        
    - name: Wait for SSH to become available
      wait_for:
        host: "{{ vm_private_ip }}"
        port: 22
        timeout: 300
        delay: 10
        
    - name: Display VM details
      debug:
        msg:
          - "VM ID: {{ vm_id }}"
          - "Private IP: {{ vm_private_ip }}"
          - "Owner: {{ vm_owner_name }}"
          - "Waiting additional time for VM to fully initialize..."
          
    - name: Add VM to inventory
      add_host:
        name: "{{ vm_private_ip }}"
        groups: provisioned_vms
        ansible_user: root
        ansible_ssh_common_args: '-o StrictHostKeyChecking=no'

    - name: Wait for VM to be fully ready
      pause:
        seconds: 30

- name: Configure VM with Desktop Environment
  hosts: provisioned_vms
  become: yes
  gather_facts: yes
  vars:
    desktop_user: "client"
    desktop_password: "client"
    browser_port: 90
    
  tasks:
    # ===== System Update =====
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Upgrade all packages
      apt:
        upgrade: dist
        autoremove: yes
        autoclean: yes

    # ===== Create Desktop User =====
    - name: Create desktop user
      user:
        name: "{{ desktop_user }}"
        password: "{{ desktop_password | password_hash('sha512') }}"
        shell: /bin/bash
        create_home: yes
        state: present

    - name: Add user to sudo group
      user:
        name: "{{ desktop_user }}"
        groups: sudo
        append: yes

    # ===== Install Desktop Environment =====
    - name: Install XFCE desktop environment
      apt:
        name:
          - xfce4
          - xfce4-goodies
          - dbus-x11
          - x11-xserver-utils
        state: present

    # ===== Install and Configure XRDP =====
    - name: Install XRDP
      apt:
        name:
          - xrdp
          - xorgxrdp
        state: present

    - name: Add xrdp user to ssl-cert group
      user:
        name: xrdp
        groups: ssl-cert
        append: yes

    - name: Configure XRDP to use XFCE
      copy:
        dest: /etc/xrdp/startwm.sh
        content: |
          #!/bin/sh
          if [ -r /etc/default/locale ]; then
            . /etc/default/locale
            export LANG LANGUAGE
          fi

          # Start XFCE session
          startxfce4
        mode: '0755'
        backup: yes

    - name: Configure XRDP port
      lineinfile:
        path: /etc/xrdp/xrdp.ini
        regexp: '^port='
        line: 'port=3389'
        backup: yes

    - name: Enable and start XRDP service
      systemd:
        name: xrdp
        enabled: yes
        state: restarted

    # ===== Install Docker =====
    - name: Install required packages for Docker
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - software-properties-common
        state: present

    - name: Create directory for Docker GPG key
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: Add Docker GPG key
      shell: |
        curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
        chmod a+r /etc/apt/keyrings/docker.gpg
      args:
        creates: /etc/apt/keyrings/docker.gpg

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian {{ ansible_distribution_release }} stable"
        state: present
        filename: docker

    - name: Install Docker
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: yes

    - name: Add user to docker group
      user:
        name: "{{ desktop_user }}"
        groups: docker
        append: yes

    - name: Enable and start Docker service
      systemd:
        name: docker
        enabled: yes
        state: started

    # ===== Setup Browser in Docker =====
    - name: Create browser container directory
      file:
        path: /opt/browser-container
        state: directory
        mode: '0755'

    - name: Create Docker Compose file for browser
      copy:
        dest: /opt/browser-container/docker-compose.yml
        content: |
          version: '3.8'

          services:
            browser:
              image: lscr.io/linuxserver/chromium:latest
              container_name: web-browser
              restart: unless-stopped
              security_opt:
                - seccomp:unconfined
              environment:
                - PUID=1000
                - PGID=1000
                - TZ=Europe/Vilnius
                - CHROME_CLI=https://www.google.com
              volumes:
                - /opt/browser-container/config:/config
              ports:
                - "{{ browser_port }}:3000"
                - "{{ browser_port }}1:3001"
              shm_size: "2gb"

    - name: Create browser config directory
      file:
        path: /opt/browser-container/config
        state: directory
        mode: '0755'
        owner: "1000"
        group: "1000"

    - name: Start browser container
      command:
        cmd: docker compose up -d
        chdir: /opt/browser-container
      register: docker_compose_output
      changed_when: "'Creating web-browser' in docker_compose_output.stdout or 'Started' in docker_compose_output.stdout"

    # ===== Install Desktop Applications =====
    - name: Install additional useful packages
      apt:
        name:
          - firefox-esr
          - thunar
          - mousepad
          - xfce4-terminal
          - network-manager-gnome
          - pavucontrol
          - htop
          - curl
          - wget
          - git
          - vim
          - net-tools
        state: present

    # ===== Configure Firewall =====
    - name: Install UFW
      apt:
        name: ufw
        state: present

    - name: Allow SSH
      ufw:
        rule: allow
        port: '22'
        proto: tcp

    - name: Allow RDP
      ufw:
        rule: allow
        port: '3389'
        proto: tcp

    - name: Allow browser port
      ufw:
        rule: allow
        port: '{{ browser_port }}'
        proto: tcp

    - name: Enable UFW
      ufw:
        state: enabled
        policy: deny

    # ===== Create Desktop Shortcuts =====
    - name: Create Desktop directory
      file:
        path: "/home/{{ desktop_user }}/Desktop"
        state: directory
        owner: "{{ desktop_user }}"
        group: "{{ desktop_user }}"
        mode: '0755'

    - name: Create browser shortcut on desktop
      copy:
        dest: "/home/{{ desktop_user }}/Desktop/docker-browser.desktop"
        content: |
          [Desktop Entry]
          Version=1.0
          Type=Application
          Name=Docker Browser
          Comment=Access Chromium in Docker
          Exec=firefox-esr http://localhost:{{ browser_port }}
          Icon=web-browser
          Terminal=false
          Categories=Network;WebBrowser;
        owner: "{{ desktop_user }}"
        group: "{{ desktop_user }}"
        mode: '0755'

    # ===== Get Port Forwarding Information =====
    - name: Get VM information from OpenNebula
      delegate_to: localhost
      uri:
        url: "https://grid5.mif.vu.lt/cloud3/RPC2"
        method: POST
        body_format: raw
        headers:
          Content-Type: "text/xml"
        body: |
          <?xml version="1.0"?>
          <methodCall>
            <methodName>one.vm.info</methodName>
            <params>
              <param><value><string>{{ client_user }}:{{ client_pass }}</string></value></param>
              <param><value><int>{{ hostvars['localhost']['vm_id'] }}</int></value></param>
            </params>
          </methodCall>
        return_content: yes
        validate_certs: yes
      register: vm_info
      vars:
        client_user: "{{ hostvars['localhost']['client_user'] }}"
        client_pass: "{{ hostvars['localhost']['client_pass'] }}"

    # ===== Save Connection Information =====
    - name: Save connection information to file
      copy:
        content: |
          ================================================
          VM DESKTOP ENVIRONMENT - CONNECTION INFORMATION
          ================================================
          
          VM Details:
          -----------
          VM ID: {{ hostvars['localhost']['vm_id'] }}
          Private IP: {{ inventory_hostname }}
          Owner: {{ hostvars['localhost']['vm_owner_name'] }}
          
          Internal Ports (inside VM):
          ---------------------------
          - SSH: 22
          - RDP/XRDP: 3389
          - Browser: {{ browser_port }}
          
          Login Credentials:
          -----------------
          Username: {{ desktop_user }}
          Password: {{ desktop_password }}
          
          Connection Instructions:
          -----------------------
          1. RDP Connection:
             - Check your VM's external port forwarding for port 3389
             - Connect using: <external_ip>:<external_rdp_port>
             - Use the credentials above
          
          2. Browser Access:
             - Check your VM's external port forwarding for port {{ browser_port }}
             - Open in browser: http://<external_ip>:<external_browser_port>
          
          3. SSH Access:
             - Check your VM's external port forwarding for port 22
             - Connect using: ssh {{ desktop_user }}@<external_ip> -p <external_ssh_port>
          
          Important Notes:
          ---------------
          - Your VM uses PORT FORWARDING
          - Internal ports (22, 3389, {{ browser_port }}) are mapped to external ports
          - Check OpenNebula VM details for exact external port mappings
          - Example: If mapping shows 8957:3389, use port 8957 to connect via RDP
          
          Services Running:
          ----------------
          - XFCE Desktop Environment
          - XRDP (Remote Desktop)
          - Docker with Chromium browser container
          - UFW Firewall (enabled)
          
          Configuration Date: {{ ansible_date_time.iso8601 }}
          ================================================
        dest: /root/connection_info.txt
        mode: '0600'

    - name: Display final connection information
      debug:
        msg:
          - "============================================"
          - "       CONFIGURATION COMPLETED!"
          - "============================================"
          - ""
          - "VM ID: {{ hostvars['localhost']['vm_id'] }}"
          - "Private IP: {{ inventory_hostname }}"
          - ""
          - "CREDENTIALS:"
          - "  Username: {{ desktop_user }}"
          - "  Password: {{ desktop_password }}"
          - ""
          - "SERVICES CONFIGURED:"
          - "  ✓ XFCE Desktop Environment"
          - "  ✓ XRDP Remote Desktop (port 3389)"
          - "  ✓ Docker with Browser (port {{ browser_port }})"
          - "  ✓ UFW Firewall"
          - ""
          - "IMPORTANT:"
          - "Check OpenNebula for external port mappings!"
          - "Connection info saved to: /root/connection_info.txt"
          - ""
          - "============================================"
